{ stdenv, lib, fetchurl, dpkg }:

stdenv.mkDerivation rec {
  pname = "thorium-browser";
  version = "128.0.6613.189";

  src = fetchurl {
    url = "https://github.com/Alex313031/thorium/releases/download/M${version}/${pname}_${version}_AVX2.deb";
    sha256 = "oid72E4n9jAQsCUrztlyj56Gd0+pz735y6b5COMA4tg=";
  };

  # deps = [ alsa-lib at-spi2-core cairo dbus libcups libnotify libxcomposite libxkbcommon libxrandr mesa nspr nss pango ];

  dontBuild = true;
  nativeBuildInputs = [dpkg];

  # unpack completes

  unpackPhase = ''
    dpkg-deb --fsys-tarfile $src | tar -x --no-same-permissions --no-same-owner
    ls -a
  '';

  # WIP install phase

  installPhase = ''
    mkdir -p $out $out/bin

    cp -R usr/share $out
    cp -R opt/ $out/opt

    export BINARYWRAPPER=$out/opt/brave.com/brave/brave-browser



    substituteInPlace $BINARYWRAPPER \
          --replace /bin/bash ${stdenv.shell}

    ln -sf $BINARYWRAPPER $out/bin/brave

    for exe in $out/opt/brave.com/brave/{brave,chrome_crashpad_handler}; do
        patchelf \
            --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" \
            --set-rpath "${rpath}" $exe
    done
  '';

  meta = with lib; {
    description = "Chromium fork named after radioactive element No. 90.";
    homepage = "https://github.com/Alex313031/thorium";
    license = licenses.bsd3;
    platforms = platforms.unix;
  };
}
